<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixly Taller - Sistema de Gestión</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
        }
        .chart-container {
            height: 300px;
        }
        .sidebar-active {
            background-color: #4F46E5;
            color: white;
        }
        .user-menu {
            transition: all 0.3s ease;
        }
        .user-menu:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 200px;
        }
        .dropdown-menu.show {
            display: block;
        }
        .session-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Session Check & Security -->
    <script>
        // Authentication Guard - Must be at the top
        class TallerSessionGuard {
            constructor() {
                this.API_BASE_URL = 'https://api.fixlytaller.com';
                this.checkAuthentication();
            }

            async checkAuthentication() {
                const sessionData = localStorage.getItem('fixly_taller_session') || 
                                  sessionStorage.getItem('fixly_taller_session');
                
                if (!sessionData) {
                    this.redirectToLogin();
                    return;
                }

                try {
                    const session = JSON.parse(sessionData);
                    
                    // Verificar si la sesión es válida con el backend
                    const isValid = await this.validateSession(session);
                    if (!isValid) {
                        this.clearSession();
                        this.redirectToLogin();
                        return;
                    }
                    
                    // Update session info in navbar
                    this.updateSessionInfo(session);
                } catch (error) {
                    console.error('Session validation error:', error);
                    this.clearSession();
                    this.redirectToLogin();
                }
            }

            async validateSession(session) {
                try {
                    const response = await fetch(`${this.API_BASE_URL}/api/validate-session`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            username: session.username,
                            token: session.token 
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.success;
                    }
                } catch (error) {
                    console.error('Error validating session:', error);
                }
                
                // Fallback: check expiration time locally
                const loginTime = new Date(session.loginTime);
                const now = new Date();
                const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
                return hoursSinceLogin < 24; // 24 hours expiration
            }

            updateSessionInfo(session) {
                // Update username display
                const usernameDisplay = document.getElementById('username-display');
                if (usernameDisplay) {
                    usernameDisplay.textContent = session.empresa || session.username;
                }

                // Update login time
                const loginTimeDisplay = document.getElementById('login-time');
                if (loginTimeDisplay) {
                    const loginTime = new Date(session.loginTime);
                    loginTimeDisplay.textContent = `Conectado: ${loginTime.toLocaleString('es-ES')}`;
                }

                // Update plan info
                const planDisplay = document.getElementById('plan-display');
                if (planDisplay) {
                    planDisplay.textContent = session.plan || 'Básico';
                    planDisplay.className = `px-2 py-1 rounded-full text-xs ${
                        session.plan === 'premium' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'
                    }`;
                }
            }

            clearSession() {
                localStorage.removeItem('fixly_taller_session');
                sessionStorage.removeItem('fixly_taller_session');
            }

            redirectToLogin() {
                window.location.href = 'taller-login.html';
            }

            logout() {
                this.clearSession();
                this.redirectToLogin();
            }
        }

        // Initialize session guard immediately
        const tallerSessionGuard = new TallerSessionGuard();
    </script>

    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-tools mr-3 text-xl"></i>
                    <h1 class="text-xl font-bold">Fixly Taller</h1>
                    <span class="session-indicator ml-4 px-2 py-1 bg-green-500 bg-opacity-20 rounded-full text-xs">
                        <i class="fas fa-circle text-green-400 mr-1"></i>Sistema Activo
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right text-sm">
                        <div>Taller: <span id="username-display" class="font-semibold">Cargando...</span></div>
                        <div class="flex items-center space-x-2">
                            <span id="plan-display" class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Plan</span>
                            <span id="login-time" class="text-xs opacity-75">Conectado: --</span>
                        </div>
                    </div>
                    <div class="relative">
                        <button id="user-menu-btn" class="user-menu flex items-center space-x-2 px-3 py-2 rounded-lg">
                            <i class="fas fa-user-circle text-2xl"></i>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="user-dropdown" class="dropdown-menu">
                            <div class="p-2">
                                <a href="#profile" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 rounded">
                                    <i class="fas fa-user mr-3"></i>Mi Perfil
                                </a>
                                <a href="#settings" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 rounded">
                                    <i class="fas fa-cog mr-3"></i>Configuración
                                </a>
                                <a href="#support" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 rounded">
                                    <i class="fas fa-life-ring mr-3"></i>Soporte
                                </a>
                                <hr class="my-2">
                                <button id="logout-btn" class="w-full flex items-center px-3 py-2 text-red-600 hover:bg-red-50 rounded">
                                    <i class="fas fa-sign-out-alt mr-3"></i>Cerrar Sesión
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg">
            <nav class="mt-8">
                <a href="#dashboard" class="sidebar-item sidebar-active flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" data-section="dashboard">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    Dashboard
                </a>
                <a href="#reparaciones" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" data-section="reparaciones">
                    <i class="fas fa-wrench mr-3"></i>
                    Reparaciones
                </a>
                <a href="#clientes" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" data-section="clientes">
                    <i class="fas fa-users mr-3"></i>
                    Clientes
                </a>
                <a href="#inventario" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" data-section="inventario">
                    <i class="fas fa-boxes mr-3"></i>
                    Inventario
                </a>
                <a href="#facturas" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" data-section="facturas">
                    <i class="fas fa-file-invoice mr-3"></i>
                    Facturación
                </a>
                <a href="#reportes" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" data-section="reportes">
                    <i class="fas fa-chart-bar mr-3"></i>
                    Reportes
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="content-section">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Dashboard del Taller</h2>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg p-6 shadow">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <i class="fas fa-tools text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Reparaciones Activas</p>
                                <p class="text-2xl font-bold text-gray-900" id="reparaciones-activas">12</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 shadow">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <i class="fas fa-check-circle text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Completadas Hoy</p>
                                <p class="text-2xl font-bold text-gray-900" id="completadas-hoy">8</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 shadow">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100">
                                <i class="fas fa-dollar-sign text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Ingresos del Mes</p>
                                <p class="text-2xl font-bold text-gray-900" id="ingresos-mes">$48,500</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 shadow">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-red-100">
                                <i class="fas fa-users text-red-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Clientes Activos</p>
                                <p class="text-2xl font-bold text-gray-900" id="clientes-activos">156</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div class="bg-white rounded-lg p-6 shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Acciones Rápidas</h3>
                        <div class="space-y-3">
                            <button class="w-full flex items-center justify-start px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                                <i class="fas fa-plus-circle text-blue-600 mr-3"></i>
                                Nueva Reparación
                            </button>
                            <button class="w-full flex items-center justify-start px-4 py-3 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                                <i class="fas fa-user-plus text-green-600 mr-3"></i>
                                Agregar Cliente
                            </button>
                            <button class="w-full flex items-center justify-start px-4 py-3 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors">
                                <i class="fas fa-file-invoice-dollar text-yellow-600 mr-3"></i>
                                Generar Factura
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Reparaciones Pendientes</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium text-gray-800">iPhone 12 - Juan Pérez</p>
                                    <p class="text-sm text-gray-600">Pantalla rota</p>
                                </div>
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Pendiente</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium text-gray-800">Samsung S21 - Ana López</p>
                                    <p class="text-sm text-gray-600">Batería agotada</p>
                                </div>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">En proceso</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Estado del Inventario</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Pantallas iPhone</span>
                                <span class="font-medium text-green-600">15 unidades</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Baterías Samsung</span>
                                <span class="font-medium text-yellow-600">3 unidades</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Cables USB-C</span>
                                <span class="font-medium text-red-600">0 unidades</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-lg p-6 shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Reparaciones por Mes</h3>
                        <div class="chart-container">
                            <canvas id="reparacionesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Ingresos Mensuales</h3>
                        <div class="chart-container">
                            <canvas id="ingresosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Otras secciones se agregarían aquí -->
            <div id="reparaciones-section" class="content-section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Gestión de Reparaciones</h2>
                <div class="bg-white rounded-lg p-6 shadow">
                    <p class="text-gray-600">Sección de reparaciones en desarrollo...</p>
                </div>
            </div>

            <div id="clientes-section" class="content-section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Gestión de Clientes</h2>
                <div class="bg-white rounded-lg p-6 shadow">
                    <p class="text-gray-600">Sección de clientes en desarrollo...</p>
                </div>
            </div>

            <div id="inventario-section" class="content-section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Control de Inventario</h2>
                <div class="bg-white rounded-lg p-6 shadow">
                    <p class="text-gray-600">Sección de inventario en desarrollo...</p>
                </div>
            </div>

            <div id="facturas-section" class="content-section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Sistema de Facturación</h2>
                <div class="bg-white rounded-lg p-6 shadow">
                    <p class="text-gray-600">Sección de facturación en desarrollo...</p>
                </div>
            </div>

            <div id="reportes-section" class="content-section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Reportes y Análisis</h2>
                <div class="bg-white rounded-lg p-6 shadow">
                    <p class="text-gray-600">Sección de reportes en desarrollo...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ✅ CONFIGURACIÓN PARA API REAL
        const API_BASE_URL = 'https://api.fixlytaller.com';

        // Navigation & Session Management
        document.addEventListener('DOMContentLoaded', function() {
            // User menu dropdown
            const userMenuBtn = document.getElementById('user-menu-btn');
            const userDropdown = document.getElementById('user-dropdown');
            const logoutBtn = document.getElementById('logout-btn');

            userMenuBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                userDropdown.classList.toggle('show');
            });

            document.addEventListener('click', function() {
                userDropdown.classList.remove('show');
            });

            logoutBtn.addEventListener('click', function() {
                tallerSessionGuard.logout();
            });

            // Sidebar navigation
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            const contentSections = document.querySelectorAll('.content-section');
            
            sidebarItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all items
                    sidebarItems.forEach(i => i.classList.remove('sidebar-active'));
                    // Add active class to clicked item
                    this.classList.add('sidebar-active');
                    
                    // Hide all sections
                    contentSections.forEach(section => section.classList.add('hidden'));
                    // Show target section
                    const targetSection = document.getElementById(this.dataset.section + '-section');
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                    }
                });
            });

            // Initialize charts
            initCharts();
        });

        function initCharts() {
            // Reparaciones Chart
            const reparacionesCtx = document.getElementById('reparacionesChart').getContext('2d');
            new Chart(reparacionesCtx, {
                type: 'bar',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Reparaciones',
                        data: [45, 52, 38, 67, 59, 73],
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: '#4F46E5',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Ingresos Chart
            const ingresosCtx = document.getElementById('ingresosChart').getContext('2d');
            new Chart(ingresosCtx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Ingresos ($)',
                        data: [25000, 32000, 28000, 45000, 38000, 48500],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>