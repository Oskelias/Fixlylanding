<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixly Admin - Panel Mejorado</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
        }
        .sidebar-active {
            background-color: #4F46E5;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-wrench mr-3 text-xl"></i>
                    <h1 class="text-xl font-bold">Fixly Admin - Mejorado</h1>
                    <span class="ml-4 px-2 py-1 bg-green-500 bg-opacity-20 rounded-full text-xs">
                        <i class="fas fa-circle text-green-400 mr-1"></i>Online
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right text-sm">
                        <div>Admin Panel</div>
                        <div class="text-xs opacity-75">Versión Mejorada</div>
                    </div>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-sm">
                        <i class="fas fa-sign-out-alt mr-2"></i>Salir
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg">
            <nav class="mt-8">
                <a href="#" class="sidebar-item sidebar-active flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" onclick="showSection('registros')">
                    <i class="fas fa-inbox mr-3"></i>
                    📋 Nuevos Registros
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" onclick="showSection('crear')">
                    <i class="fas fa-user-plus mr-3"></i>
                    👤 Crear Usuario Manual
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" onclick="showSection('usuarios')">
                    <i class="fas fa-users mr-3"></i>
                    👥 Usuarios Creados
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" onclick="showSection('test')">
                    <i class="fas fa-vial mr-3"></i>
                    🧪 Test Sistema
                </a>
                <a href="#" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50" onclick="showSection('config')">
                    <i class="fas fa-cog mr-3"></i>
                    ⚙️ Configuración
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            
            <!-- Sección: Nuevos Registros -->
            <div id="registros-section" class="content-section">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold">📋 Nuevos Registros Pendientes</h2>
                        <button onclick="actualizarRegistros()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            <i class="fas fa-sync mr-2"></i>Actualizar
                        </button>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <p class="text-sm"><strong>💡 Flujo:</strong> Cliente se registra → Te llega Telegram → Aquí aparece → Tú creas usuario → Email automático</p>
                    </div>
                    
                    <div id="listaRegistros" class="space-y-3">
                        <!-- Los registros aparecerán aquí -->
                    </div>
                </div>
            </div>

            <!-- Sección: Crear Usuario Manual -->
            <div id="crear-section" class="content-section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Datos del Registro -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-semibold mb-6">📋 Datos del Cliente</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">🏢 Empresa/Taller:</label>
                                <input type="text" id="clienteEmpresa" placeholder="Taller Mecánico López" 
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">📧 Email:</label>
                                <input type="email" id="clienteEmail" placeholder="contacto@tallerlopez.com" 
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">📱 Teléfono:</label>
                                <input type="tel" id="clienteTelefono" placeholder="+54 11 1234-5678" 
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Credenciales -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-semibold mb-6">🔐 Credenciales de Acceso</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">👤 Usuario:</label>
                                <div class="flex gap-2">
                                    <input type="text" id="nuevoUsuario" placeholder="lopez_taller_45" 
                                           class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <button onclick="generarUsuarioSugerido()" 
                                            class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 text-sm">
                                        🎲
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">🔒 Contraseña:</label>
                                <div class="flex gap-2">
                                    <input type="text" id="nuevaPassword" placeholder="fixly123" 
                                           class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <button onclick="generarPasswordSimple()" 
                                            class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm">
                                        🎲
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">📅 Duración:</label>
                                <select id="duracionPlan" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="15">15 días - Prueba Gratuita</option>
                                    <option value="30">30 días - Plan Mensual</option>
                                    <option value="90">90 días - Plan Trimestral</option>
                                    <option value="365">365 días - Plan Anual</option>
                                </select>
                            </div>
                            
                            <div class="pt-4 space-y-3">
                                <button onclick="crearUsuarioCompleto()" 
                                        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">
                                    ✅ Crear Usuario + Enviar Email
                                </button>
                                
                                <button onclick="soloMostrarCredenciales()" 
                                        class="w-full bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700">
                                    👀 Solo Mostrar Credenciales
                                </button>
                            </div>
                        </div>
                        
                        <div id="resultadoCreacion" class="hidden mt-4 p-4 rounded-lg"></div>
                    </div>
                </div>
            </div>

            <!-- Sección: Usuarios Creados -->
            <div id="usuarios-section" class="content-section hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold">👥 Usuarios Creados</h2>
                        <button onclick="actualizarUsuarios()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                            <i class="fas fa-sync mr-2"></i>Actualizar
                        </button>
                    </div>
                    
                    <div id="tablaUsuarios" class="overflow-x-auto">
                        <!-- Tabla de usuarios aquí -->
                    </div>
                </div>
            </div>

            <!-- Sección: Test Sistema -->
            <div id="test-section" class="content-section hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6">🧪 Test del Sistema</h2>
                    
                    <!-- Test Health -->
                    <div class="border rounded-lg p-4 mb-6">
                        <h3 class="font-semibold mb-3">1. ☁️ Worker Health Check</h3>
                        <button onclick="testHealth()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            Verificar Worker
                        </button>
                        <div id="healthResult" class="hidden mt-3 p-3 rounded"></div>
                    </div>

                    <!-- Test Login -->
                    <div class="border rounded-lg p-4 mb-6">
                        <h3 class="font-semibold mb-3">2. 🔐 Test de Login</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" id="testUsuario" placeholder="Usuario" 
                                   class="px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            <input type="password" id="testPassword" placeholder="Contraseña" 
                                   class="px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            <button onclick="testLogin()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                                🔓 Test Login
                            </button>
                        </div>
                        <div class="flex gap-2 text-sm">
                            <button onclick="testAdminLogin()" class="bg-indigo-500 text-white px-3 py-1 rounded text-xs">
                                Admin Login
                            </button>
                        </div>
                        <div id="loginTestResult" class="hidden mt-3 p-3 rounded"></div>
                    </div>
                </div>
            </div>

            <!-- Sección: Configuración -->
            <div id="config-section" class="content-section hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6">⚙️ Configuración del Sistema</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h3 class="font-semibold">📧 Email Configuration</h3>
                            <div class="bg-gray-50 p-4 rounded">
                                <p class="text-sm"><strong>From Email:</strong> noreply@fixlytaller.com</p>
                                <p class="text-sm"><strong>Admin Email:</strong> admin@fixlytaller.com</p>
                                <p class="text-sm"><strong>Status:</strong> <span class="text-green-600">✅ Configurado</span></p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <h3 class="font-semibold">📱 Telegram Configuration</h3>
                            <div class="bg-gray-50 p-4 rounded">
                                <p class="text-sm"><strong>Bot Token:</strong> ***...bWaAA (Configurado)</p>
                                <p class="text-sm"><strong>Chat ID:</strong> ***...7108 (Configurado)</p>
                                <p class="text-sm"><strong>Status:</strong> <span class="text-green-600">✅ Activo</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="font-semibold mb-3">🔗 URLs del Sistema</h3>
                        <div class="bg-blue-50 p-4 rounded space-y-2 text-sm">
                            <p><strong>API Backend:</strong> https://api.fixlytaller.com</p>
                            <p><strong>App Cliente:</strong> https://app.fixlytaller.com</p>
                            <p><strong>Login Taller:</strong> https://app.fixlytaller.com/login</p>
                            <p><strong>Sistema Taller:</strong> https://app.fixlytaller.com/sistema</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api.fixlytaller.com';
        let registroSeleccionado = null;

        // Navegación entre secciones
        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Mostrar sección seleccionada
            document.getElementById(sectionName + '-section').classList.remove('hidden');
            
            // Actualizar sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('sidebar-active');
            });
            event.target.classList.add('sidebar-active');
            
            // Cargar datos específicos de la sección
            if (sectionName === 'registros') {
                actualizarRegistros();
            } else if (sectionName === 'usuarios') {
                actualizarUsuarios();
            }
        }

        // Funciones de generación automática
        function generarUsuarioSugerido() {
            const empresa = document.getElementById('clienteEmpresa').value;
            if (!empresa) {
                alert('Ingresa el nombre de la empresa primero');
                return;
            }
            
            const empresaLimpia = empresa
                .toLowerCase()
                .replace(/taller|mecánico|automotor|service|garage/gi, '') // Quitar palabras comunes
                .replace(/[^a-z0-9\s]/g, '') // Solo letras y números
                .trim()
                .replace(/\s+/g, '_') // Espacios por guiones
                .substring(0, 10); // Máximo 10 caracteres
                
            const numero = Math.floor(10 + Math.random() * 90); // 10-99
            
            document.getElementById('nuevoUsuario').value = `${empresaLimpia || 'taller'}_${numero}`;
        }

        function generarPasswordSimple() {
            const palabras = ['fixly', 'taller', 'auto', 'mecanico', 'service', 'garage'];
            const palabra = palabras[Math.floor(Math.random() * palabras.length)];
            const numero = Math.floor(100 + Math.random() * 900); // 100-999
            
            document.getElementById('nuevaPassword').value = `${palabra}${numero}`;
        }

        // Crear usuario completo con email
        async function crearUsuarioCompleto() {
            const datos = obtenerDatosFormulario();
            if (!datos) return;
            
            mostrarResultado('🔄 Creando usuario y enviando email...', 'blue');
            
            try {
                const response = await fetch(`${API_BASE}/api/generate-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        empresa: datos.empresa,
                        email: datos.email,
                        telefono: datos.telefono,
                        tipo: 'manual',
                        duracion: parseInt(datos.duracion),
                        usuarioManual: datos.usuario,
                        passwordManual: datos.password
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    mostrarResultado(`
                        🎉 ¡Usuario creado exitosamente!<br>
                        <div class="mt-3 p-3 bg-blue-50 rounded">
                            <strong>👤 Usuario:</strong> ${result.username}<br>
                            <strong>🔒 Password:</strong> ${datos.password}<br>
                            <strong>📧 Email enviado a:</strong> ${datos.email}<br>
                            <strong>📱 Telegram:</strong> ${result.notificaciones?.telegram || 'Enviado'}<br>
                            <strong>📅 Expira:</strong> ${new Date(result.fechaExpiracion).toLocaleDateString('es-ES')}
                        </div>
                    `, 'green');
                    
                    // Auto-fill test de login
                    document.getElementById('testUsuario').value = result.username;
                    document.getElementById('testPassword').value = datos.password;
                    
                    // Limpiar formulario
                    limpiarFormulario();
                    
                } else {
                    const error = await response.text();
                    mostrarResultado(`❌ Error del servidor: ${error}`, 'red');
                }
            } catch (error) {
                mostrarResultado(`❌ Error de conexión: ${error.message}`, 'red');
            }
        }

        // Solo mostrar credenciales sin crear
        function soloMostrarCredenciales() {
            const datos = obtenerDatosFormulario();
            if (!datos) return;
            
            mostrarResultado(`
                👤 Credenciales generadas (no enviadas):<br>
                <div class="mt-3 p-3 bg-gray-100 rounded font-mono">
                    <strong>🏢 Empresa:</strong> ${datos.empresa}<br>
                    <strong>👤 Usuario:</strong> ${datos.usuario}<br>
                    <strong>🔒 Password:</strong> ${datos.password}<br>
                    <strong>📧 Email:</strong> ${datos.email}<br>
                    <strong>📅 Duración:</strong> ${datos.duracion} días
                </div>
                <div class="mt-2 text-sm text-gray-600">
                    💡 Puedes copiar estas credenciales y enviarlas manualmente,<br>
                    o usar "Crear Usuario + Enviar Email" para automatizar el proceso.
                </div>
            `, 'yellow');
        }

        // Test functions
        async function testHealth() {
            const resultDiv = document.getElementById('healthResult');
            resultDiv.className = 'mt-3 p-3 rounded bg-blue-100 text-blue-800';
            resultDiv.innerHTML = '🔄 Verificando Worker...';
            resultDiv.classList.remove('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'mt-3 p-3 rounded bg-green-100 text-green-800';
                    resultDiv.innerHTML = `
                        ✅ Worker funcionando correctamente<br>
                        <small>Versión: ${data.version} | Estado: ${data.status}</small>
                    `;
                } else {
                    resultDiv.className = 'mt-3 p-3 rounded bg-red-100 text-red-800';
                    resultDiv.innerHTML = `❌ Worker error: ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'mt-3 p-3 rounded bg-red-100 text-red-800';
                resultDiv.innerHTML = `❌ Error de conexión: ${error.message}`;
            }
        }

        async function testLogin() {
            const usuario = document.getElementById('testUsuario').value;
            const password = document.getElementById('testPassword').value;
            
            if (!usuario || !password) {
                alert('Ingresa usuario y contraseña');
                return;
            }
            
            const resultDiv = document.getElementById('loginTestResult');
            resultDiv.className = 'mt-3 p-3 rounded bg-blue-100 text-blue-800';
            resultDiv.innerHTML = '🔄 Probando login...';
            resultDiv.classList.remove('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: usuario, password })
                });

                if (response.ok) {
                    const result = await response.json();
                    resultDiv.className = 'mt-3 p-3 rounded bg-green-100 text-green-800';
                    resultDiv.innerHTML = `✅ Login exitoso - ${result.user.empresa} (${result.user.role})`;
                } else {
                    const error = await response.text();
                    resultDiv.className = 'mt-3 p-3 rounded bg-red-100 text-red-800';
                    resultDiv.innerHTML = `❌ Login falló: ${error}`;
                }
            } catch (error) {
                resultDiv.className = 'mt-3 p-3 rounded bg-red-100 text-red-800';
                resultDiv.innerHTML = `❌ Error: ${error.message}`;
            }
        }

        function testAdminLogin() {
            document.getElementById('testUsuario').value = 'admin';
            document.getElementById('testPassword').value = 'fixly2024!';
            testLogin();
        }

        // Funciones auxiliares
        function obtenerDatosFormulario() {
            const empresa = document.getElementById('clienteEmpresa').value.trim();
            const email = document.getElementById('clienteEmail').value.trim();
            const usuario = document.getElementById('nuevoUsuario').value.trim();
            const password = document.getElementById('nuevaPassword').value.trim();
            
            if (!empresa || !email || !usuario || !password) {
                alert('Completa todos los campos obligatorios');
                return null;
            }
            
            if (!email.includes('@')) {
                alert('Email inválido');
                return null;
            }
            
            return {
                empresa,
                email,
                telefono: document.getElementById('clienteTelefono').value.trim(),
                usuario,
                password,
                duracion: document.getElementById('duracionPlan').value
            };
        }

        function mostrarResultado(mensaje, tipo) {
            const div = document.getElementById('resultadoCreacion');
            const colores = {
                blue: 'bg-blue-100 text-blue-800',
                green: 'bg-green-100 text-green-800',
                yellow: 'bg-yellow-100 text-yellow-800',
                red: 'bg-red-100 text-red-800'
            };
            
            div.className = `mt-4 p-4 rounded-lg ${colores[tipo]}`;
            div.innerHTML = mensaje;
            div.classList.remove('hidden');
        }

        function limpiarFormulario() {
            document.getElementById('clienteEmpresa').value = '';
            document.getElementById('clienteEmail').value = '';
            document.getElementById('clienteTelefono').value = '';
            document.getElementById('nuevoUsuario').value = '';
            document.getElementById('nuevaPassword').value = '';
        }

        // Funciones de carga de datos (placeholders)
        function actualizarRegistros() {
            const div = document.getElementById('listaRegistros');
            div.innerHTML = `
                <div class="text-center p-8 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-4 opacity-50"></i>
                    <p>No hay registros pendientes</p>
                    <p class="text-sm mt-2">Los nuevos registros de fixlytaller.com aparecerán aquí</p>
                    <p class="text-sm">También recibirás notificación por Telegram</p>
                </div>
            `;
        }

        function actualizarUsuarios() {
            const div = document.getElementById('tablaUsuarios');
            div.innerHTML = `
                <div class="text-center p-8 text-gray-500">
                    <i class="fas fa-users text-4xl mb-4 opacity-50"></i>
                    <p>No hay usuarios creados</p>
                    <p class="text-sm mt-2">Los usuarios que crees aparecerán aquí con toda la información</p>
                </div>
            `;
        }

        function logout() {
            if (confirm('¿Cerrar sesión?')) {
                window.location.href = 'app-login.html';
            }
        }

        // Auto-generar ejemplos
        document.addEventListener('DOMContentLoaded', () => {
            // Valores por defecto
            document.getElementById('clienteEmpresa').value = 'Taller López';
            document.getElementById('clienteEmail').value = 'grupocioacr@gmail.com';
            document.getElementById('clienteTelefono').value = '+54 11 1234-5678';
            
            // Auto-generar sugerencias
            generarUsuarioSugerido();
            generarPasswordSimple();
            
            // Auto-fill test admin
            document.getElementById('testUsuario').value = 'admin';
            document.getElementById('testPassword').value = 'fixly2024!';
            
            // Cargar datos iniciales
            actualizarRegistros();
        });
    </script>
</body>
</html>