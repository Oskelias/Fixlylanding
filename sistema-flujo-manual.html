<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Manual - Fixly Taller</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-3xl font-bold mb-8 text-center">🛠️ Sistema Manual Fixly Taller</h1>
        
        <!-- Explicación del Flujo -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-6 mb-8 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">🔄 Flujo de Trabajo Manual</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-600 mb-2">1️⃣ Cliente se Registra</h3>
                    <p class="text-sm">En fixlytaller.com llena formulario → Te llega notificación Telegram</p>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h3 class="font-semibold text-green-600 mb-2">2️⃣ Tú Procesas</h3>
                    <p class="text-sm">Revisas registro → Creas usuario/password aquí → Sistema envía email</p>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h3 class="font-semibold text-purple-600 mb-2">3️⃣ Cliente Recibe</h3>
                    <p class="text-sm">Email con credenciales → Accede a app.fixlytaller.com</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Panel Izquierdo: Registros Pendientes -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">📋 Registros Pendientes</h2>
                    <button onclick="cargarRegistrosPendientes()" 
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        🔄 Actualizar
                    </button>
                </div>
                
                <div id="registrosPendientes" class="space-y-3">
                    <div class="text-center p-8 text-gray-500">
                        <p>📱 Los registros de fixlytaller.com aparecerán aquí</p>
                        <p class="text-sm mt-2">Recibirás notificación Telegram cuando llegue un nuevo registro</p>
                    </div>
                </div>
            </div>

            <!-- Panel Derecho: Crear Usuario -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-6">👨‍💼 Crear Usuario para Registro</h2>
                
                <!-- Datos del Registro (auto-completados) -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <h3 class="font-medium mb-3">📋 Datos del Registro:</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <input type="text" id="registroEmpresa" placeholder="Nombre de la empresa" 
                               class="px-3 py-2 border rounded-lg bg-white" readonly>
                        <input type="email" id="registroEmail" placeholder="Email del registro" 
                               class="px-3 py-2 border rounded-lg bg-white" readonly>
                        <input type="tel" id="registroTelefono" placeholder="Teléfono" 
                               class="px-3 py-2 border rounded-lg bg-white" readonly>
                    </div>
                    <input type="hidden" id="registroId" value="">
                </div>
                
                <!-- Credenciales a Crear -->
                <div class="space-y-4">
                    <h3 class="font-medium">🔐 Credenciales de Acceso:</h3>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">👤 Usuario:</label>
                        <div class="flex gap-2">
                            <input type="text" id="nuevoUsuario" placeholder="lopez_taller" 
                                   class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button onclick="generarUsuarioSugerido()" 
                                    class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 text-sm">
                                🎲 Sugerir
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">🔒 Contraseña:</label>
                        <div class="flex gap-2">
                            <input type="text" id="nuevaPassword" placeholder="fixly123" 
                                   class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button onclick="generarPasswordSimple()" 
                                    class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm">
                                🎲 Simple
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">📅 Duración del Acceso:</label>
                        <select id="duracionAcceso" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="15">15 días (Prueba Gratuita)</option>
                            <option value="30">30 días (Plan Mensual)</option>
                            <option value="90">90 días (Plan Trimestral)</option>
                            <option value="365">365 días (Plan Anual)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Botones de Acción -->
                <div class="mt-6 space-y-3">
                    <button onclick="crearYEnviarCredenciales()" 
                            class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">
                        ✅ Crear Usuario y Enviar Email de Bienvenida
                    </button>
                    
                    <button onclick="rechazarRegistro()" 
                            class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700">
                        ❌ Rechazar Registro
                    </button>
                </div>
                
                <!-- Resultado -->
                <div id="resultadoCreacion" class="hidden mt-4 p-4 rounded-lg"></div>
            </div>
        </div>

        <!-- Lista de Usuarios Activos -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">👥 Usuarios Activos</h2>
                <button onclick="cargarUsuariosActivos()" 
                        class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                    🔄 Actualizar
                </button>
            </div>
            
            <div id="usuariosActivos" class="space-y-3">
                <p class="text-gray-500 text-center p-4">Cargando usuarios activos...</p>
            </div>
        </div>

        <!-- Test de Login -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-semibold mb-6">🧪 Test de Login Rápido</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="testUser" placeholder="Usuario" 
                       class="px-3 py-2 border rounded-lg">
                <input type="password" id="testPass" placeholder="Contraseña" 
                       class="px-3 py-2 border rounded-lg">
                <button onclick="probarLogin()" 
                        class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                    🔓 Test Login
                </button>
                <div class="text-sm text-gray-600 flex items-center">
                    <span>Admin: admin / fixly2024!</span>
                </div>
            </div>
            
            <div id="resultadoTest" class="hidden mt-4 p-3 rounded-lg"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api.fixlytaller.com';
        let registroSeleccionado = null;

        // Cargar registros pendientes desde el backend
        async function cargarRegistrosPendientes() {
            const container = document.getElementById('registrosPendientes');
            container.innerHTML = '<p class="text-gray-500 text-center">🔄 Cargando registros...</p>';
            
            try {
                // Llamar a endpoint que devuelve registros pendientes
                const response = await fetch(`${API_BASE}/api/registros-pendientes`);
                
                if (response.ok) {
                    const data = await response.json();
                    mostrarRegistrosPendientes(data.registros || []);
                } else {
                    // Si no existe el endpoint, mostrar ejemplo
                    mostrarEjemploRegistros();
                }
            } catch (error) {
                console.log('Endpoint no disponible, mostrando ejemplo');
                mostrarEjemploRegistros();
            }
        }

        function mostrarRegistrosPendientes(registros) {
            const container = document.getElementById('registrosPendientes');
            
            if (registros.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-6 text-gray-500">
                        <p>✅ No hay registros pendientes</p>
                        <p class="text-sm mt-2">Los nuevos registros aparecerán aquí automáticamente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = registros.map(registro => `
                <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" 
                     onclick="seleccionarRegistro('${registro.id}', '${registro.empresa}', '${registro.email}', '${registro.telefono || ''}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium">${registro.empresa}</h4>
                            <p class="text-sm text-gray-600">${registro.email}</p>
                            <p class="text-sm text-gray-500">${registro.telefono || 'Sin teléfono'}</p>
                        </div>
                        <div class="text-right">
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">Pendiente</span>
                            <p class="text-xs text-gray-500 mt-1">${new Date(registro.fecha).toLocaleString('es-ES')}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function mostrarEjemploRegistros() {
            const container = document.getElementById('registrosPendientes');
            container.innerHTML = `
                <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer border-dashed border-gray-300" 
                     onclick="seleccionarEjemplo()">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium">Taller Mecánico López</h4>
                            <p class="text-sm text-gray-600">contacto@tallerlopez.com</p>
                            <p class="text-sm text-gray-500">+54 11 1234-5678</p>
                        </div>
                        <div class="text-right">
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">Ejemplo</span>
                            <p class="text-xs text-gray-500 mt-1">Hace 2 horas</p>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-700">
                        📱 Cuando llegue un registro real desde fixlytaller.com, recibirás notificación Telegram y aparecerá aquí
                    </p>
                </div>
            `;
        }

        // Seleccionar un registro para procesar
        function seleccionarRegistro(id, empresa, email, telefono) {
            registroSeleccionado = id;
            
            document.getElementById('registroId').value = id;
            document.getElementById('registroEmpresa').value = empresa;
            document.getElementById('registroEmail').value = email;
            document.getElementById('registroTelefono').value = telefono;
            
            // Auto-generar sugerencias
            generarUsuarioSugerido();
            generarPasswordSimple();
            
            // Highlight del registro seleccionado
            document.querySelectorAll('#registrosPendientes .border').forEach(el => {
                el.classList.remove('border-blue-500', 'bg-blue-50');
            });
            event.target.closest('.border').classList.add('border-blue-500', 'bg-blue-50');
        }

        function seleccionarEjemplo() {
            seleccionarRegistro('ejemplo_123', 'Taller Mecánico López', 'contacto@tallerlopez.com', '+54 11 1234-5678');
        }

        // Generar usuario sugerido basado en empresa
        function generarUsuarioSugerido() {
            const empresa = document.getElementById('registroEmpresa').value;
            if (!empresa) return;
            
            const empresaLimpia = empresa
                .toLowerCase()
                .replace(/taller|mecánico|automotor|service/gi, '') // Quitar palabras comunes
                .replace(/[^a-z0-9\s]/g, '') // Solo letras y números
                .trim()
                .replace(/\s+/g, '_') // Espacios por guiones
                .substring(0, 12); // Máximo 12 caracteres
                
            const numero = Math.floor(10 + Math.random() * 90); // 10-99
            
            document.getElementById('nuevoUsuario').value = `${empresaLimpia}_${numero}`;
        }

        // Generar contraseña simple
        function generarPasswordSimple() {
            const palabras = ['fixly', 'taller', 'auto', 'mecanico', 'service'];
            const palabra = palabras[Math.floor(Math.random() * palabras.length)];
            const numero = Math.floor(100 + Math.random() * 900); // 100-999
            
            document.getElementById('nuevaPassword').value = `${palabra}${numero}`;
        }

        // Crear usuario y enviar credenciales
        async function crearYEnviarCredenciales() {
            const empresa = document.getElementById('registroEmpresa').value;
            const email = document.getElementById('registroEmail').value;
            const telefono = document.getElementById('registroTelefono').value;
            const usuario = document.getElementById('nuevoUsuario').value;
            const password = document.getElementById('nuevaPassword').value;
            const duracion = document.getElementById('duracionAcceso').value;
            
            if (!empresa || !email || !usuario || !password) {
                alert('Completa todos los campos requeridos');
                return;
            }
            
            mostrarResultado('🔄 Creando usuario y enviando email de bienvenida...', 'blue');
            
            try {
                const response = await fetch(`${API_BASE}/api/generate-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        empresa,
                        email,
                        telefono,
                        tipo: 'manual',
                        duracion: parseInt(duracion),
                        usuarioManual: usuario,
                        passwordManual: password,
                        procesandoRegistro: registroSeleccionado
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    mostrarResultado(`
                        🎉 ¡Usuario creado y email enviado!<br>
                        <strong>👤 Usuario:</strong> ${result.username}<br>
                        <strong>🔒 Password:</strong> ${password}<br>
                        <strong>📧 Email enviado a:</strong> ${email}<br>
                        <strong>📱 Telegram:</strong> ${result.notificaciones?.telegram || 'Enviado'}<br>
                        <strong>📅 Expira:</strong> ${new Date(result.fechaExpiracion).toLocaleDateString('es-ES')}
                    `, 'green');
                    
                    // Limpiar formulario
                    limpiarFormulario();
                    
                    // Auto-fill test
                    document.getElementById('testUser').value = result.username;
                    document.getElementById('testPass').value = password;
                    
                    // Actualizar listas
                    setTimeout(() => {
                        cargarRegistrosPendientes();
                        cargarUsuariosActivos();
                    }, 1000);
                    
                } else {
                    const error = await response.text();
                    mostrarResultado(`❌ Error: ${error}`, 'red');
                }
            } catch (error) {
                mostrarResultado(`❌ Error de conexión: ${error.message}`, 'red');
            }
        }

        // Rechazar registro
        async function rechazarRegistro() {
            if (!registroSeleccionado) {
                alert('Selecciona un registro primero');
                return;
            }
            
            if (!confirm('¿Rechazar este registro?')) return;
            
            mostrarResultado('❌ Registro rechazado (función por implementar)', 'red');
            
            // Aquí podrías llamar a un endpoint para marcar como rechazado
            // y enviar email de rechazo al cliente
            
            limpiarFormulario();
            cargarRegistrosPendientes();
        }

        // Test de login
        async function probarLogin() {
            const usuario = document.getElementById('testUser').value;
            const password = document.getElementById('testPass').value;
            
            if (!usuario || !password) {
                alert('Ingresa usuario y contraseña');
                return;
            }
            
            const div = document.getElementById('resultadoTest');
            div.className = 'mt-4 p-3 rounded-lg bg-blue-100 text-blue-800';
            div.innerHTML = '🔄 Probando login...';
            div.classList.remove('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: usuario, password })
                });

                if (response.ok) {
                    const result = await response.json();
                    div.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-800';
                    div.innerHTML = `✅ Login OK - ${result.user.empresa} (${result.user.role})`;
                } else {
                    const error = await response.text();
                    div.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-800';
                    div.innerHTML = `❌ Login falló: ${error}`;
                }
            } catch (error) {
                div.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-800';
                div.innerHTML = `❌ Error: ${error.message}`;
            }
        }

        // Funciones auxiliares
        function mostrarResultado(mensaje, tipo) {
            const div = document.getElementById('resultadoCreacion');
            const colores = {
                blue: 'bg-blue-100 text-blue-800',
                green: 'bg-green-100 text-green-800',
                red: 'bg-red-100 text-red-800'
            };
            
            div.className = `mt-4 p-4 rounded-lg ${colores[tipo]}`;
            div.innerHTML = mensaje;
            div.classList.remove('hidden');
        }

        function limpiarFormulario() {
            document.getElementById('registroId').value = '';
            document.getElementById('registroEmpresa').value = '';
            document.getElementById('registroEmail').value = '';
            document.getElementById('registroTelefono').value = '';
            document.getElementById('nuevoUsuario').value = '';
            document.getElementById('nuevaPassword').value = '';
            registroSeleccionado = null;
            
            document.getElementById('resultadoCreacion').classList.add('hidden');
        }

        async function cargarUsuariosActivos() {
            const div = document.getElementById('usuariosActivos');
            div.innerHTML = '<p class="text-gray-500 text-center">🔄 Cargando usuarios...</p>';
            
            // Simular carga (implementar endpoint real)
            setTimeout(() => {
                div.innerHTML = `
                    <div class="text-center p-6 text-gray-500">
                        <p>👥 Lista de usuarios activos</p>
                        <p class="text-sm mt-2">Los usuarios creados aparecerán aquí con estado y fecha de expiración</p>
                    </div>
                `;
            }, 1000);
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            cargarRegistrosPendientes();
            cargarUsuariosActivos();
            
            // Test con credenciales admin
            document.getElementById('testUser').value = 'admin';
            document.getElementById('testPass').value = 'fixly2024!';
        });
    </script>
</body>
</html>