<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parche M√≠nimo - Fixly Backend</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-2xl font-bold mb-6">üîß Parche M√≠nimo para Tu Backend</h1>
        
        <div class="bg-green-100 border-l-4 border-green-500 p-4 mb-6">
            <h2 class="font-semibold text-green-800">‚úÖ ¬°NO BORRES NADA!</h2>
            <p class="text-green-700">Solo necesitas reemplazar 3 funciones espec√≠ficas. Tu c√≥digo actual est√° bien.</p>
        </div>

        <!-- Qu√© cambiar -->
        <div class="mb-8 border-l-4 border-blue-500 pl-6">
            <h2 class="text-xl font-semibold mb-4">üéØ Qu√© necesita cambiar</h2>
            
            <div class="bg-blue-50 p-4 rounded mb-4">
                <h3 class="font-semibold mb-2">Problemas identificados en tu backend:</h3>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><code>handleLogin</code> - No valida passwords correctamente</li>
                    <li><code>handleGenerateCode</code> - No guarda password en userData</li>
                    <li><code>handleHealth</code> - Actualizar versi√≥n para tracking</li>
                </ul>
            </div>
            
            <div class="bg-yellow-50 p-4 rounded">
                <h3 class="font-semibold mb-2">‚úÖ Lo que S√ç funciona bien (no tocar):</h3>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li>Configuraci√≥n de Telegram y MailChannels ‚úÖ</li>
                    <li>Funci√≥n CORS ‚úÖ</li>
                    <li>Funciones de email ‚úÖ</li>
                    <li>Endpoints validate-code y lead-registro ‚úÖ</li>
                    <li>Generaci√≥n de credenciales ‚úÖ</li>
                </ul>
            </div>
        </div>

        <!-- Pasos -->
        <div class="space-y-6">
            <!-- Paso 1 -->
            <div class="border-l-4 border-yellow-500 pl-6">
                <h3 class="text-lg font-semibold mb-3">üìã Paso 1: Copiar las funciones corregidas</h3>
                <button onclick="copyPatchCode()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 mb-3">
                    üìã Copiar C√≥digo del Parche
                </button>
                <div id="copyStatus" class="hidden mt-2 text-sm"></div>
                
                <div class="bg-yellow-50 p-4 rounded text-sm">
                    <p><strong>Esto copiar√°:</strong></p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>handleLogin mejorada (valida passwords correctamente)</li>
                        <li>handleGenerateCode mejorada (guarda password)</li>
                        <li>handleHealth actualizada (nueva versi√≥n)</li>
                    </ul>
                </div>
            </div>

            <!-- Paso 2 -->
            <div class="border-l-4 border-green-500 pl-6">
                <h3 class="text-lg font-semibold mb-3">üîß Paso 2: Reemplazar en Cloudflare Worker</h3>
                
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded">
                        <h4 class="font-semibold mb-2">En tu Worker fixly-backend:</h4>
                        <ol class="list-decimal list-inside space-y-2 text-sm">
                            <li><strong>Busca la funci√≥n</strong> <code>async function handleLogin(request, env)</code></li>
                            <li><strong>Selecciona toda la funci√≥n</strong> (desde <code>async function</code> hasta la <code>}</code> final)</li>
                            <li><strong>Reempl√°zala</strong> con la nueva versi√≥n del parche</li>
                            <li><strong>Repite</strong> para <code>handleGenerateCode</code> y <code>handleHealth</code></li>
                        </ol>
                    </div>
                    
                    <div class="bg-red-50 p-4 rounded">
                        <h4 class="font-semibold mb-2 text-red-800">‚ö†Ô∏è IMPORTANTE:</h4>
                        <ul class="list-disc list-inside space-y-1 text-red-700 text-sm">
                            <li><strong>NO borres</strong> las configuraciones (TELEGRAM_CONFIG, EMAIL_CONFIG)</li>
                            <li><strong>NO cambies</strong> las funciones sendTelegramNotification, sendEmail</li>
                            <li><strong>NO toques</strong> generateCode, generateCredentials, getTelegramMessage</li>
                            <li><strong>Solo reemplaza</strong> las 3 funciones espec√≠ficas del parche</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Paso 3 -->
            <div class="border-l-4 border-purple-500 pl-6">
                <h3 class="text-lg font-semibold mb-3">üöÄ Paso 3: Verificar que funciona</h3>
                
                <button onclick="testPatchedWorker()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 mb-4">
                    üß™ Test Worker Parcheado
                </button>
                
                <div id="testResult" class="hidden mt-4 p-4 rounded"></div>
                
                <div class="bg-purple-50 p-4 rounded text-sm">
                    <p><strong>El test verificar√°:</strong></p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Versi√≥n actualizada a 4.1.0-login-fixed</li>
                        <li>Endpoint /health responde correctamente</li>
                        <li>CORS configurado correctamente</li>
                    </ul>
                </div>
            </div>

            <!-- Paso 4 -->
            <div class="border-l-4 border-indigo-500 pl-6">
                <h3 class="text-lg font-semibold mb-3">‚úÖ Paso 4: Test completo de login</h3>
                
                <a href="/email-test-fixed.html" target="_blank" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 inline-block">
                    üöÄ Test Login Completo
                </a>
                
                <div class="bg-indigo-50 p-4 rounded mt-4 text-sm">
                    <p><strong>Una vez aplicado el parche:</strong></p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Crear usuario con email funcionar√°</li>
                        <li>Login con credenciales generadas funcionar√°</li>
                        <li>Emails se enviar√°n correctamente</li>
                        <li>Telegram notifications funcionar√°n</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Resumen -->
        <div class="mt-8 bg-gray-50 p-6 rounded-lg">
            <h3 class="font-semibold mb-3">üìä Resumen del Parche</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h4 class="font-semibold text-green-600">‚úÖ Se mantiene:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Todo tu c√≥digo actual</li>
                        <li>Configuraciones existentes</li>
                        <li>Funciones de email/telegram</li>
                        <li>Endpoints existentes</li>
                        <li>Sistema de KV storage</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-blue-600">üîß Se mejora:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Validaci√≥n de passwords</li>
                        <li>Almacenamiento de credenciales</li>
                        <li>Login de admin (admin/fixly2024!)</li>
                        <li>Manejo de errores</li>
                        <li>Tracking de versi√≥n</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- C√≥digo oculto para copiar -->
        <textarea id="patchCode" style="position: absolute; left: -9999px; opacity: 0;">
// ==========================================
// üîß SOLO REEMPLAZA LA FUNCI√ìN handleLogin
// ==========================================
async function handleLogin(request, env) {
  try {
    const data = await request.json();
    const { username, password } = data;

    if (!username || !password) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Usuario y contrase√±a requeridos'
      }), { 
        status: 400,
        headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
      });
    }

    // Verificar credenciales de admin
    if (username === 'admin' && password === 'fixly2024!') {
      return new Response(JSON.stringify({
        success: true,
        user: { username: 'admin', role: 'admin', empresa: 'Administrador' },
        message: 'Login exitoso como administrador'
      }), {
        status: 200,
        headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
      });
    }

    // Buscar usuario en KV
    const userData = await env.FIXLY_KV.get(`user_${username}`, 'json');
    
    if (!userData) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Usuario no encontrado'
      }), { 
        status: 401,
        headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
      });
    }

    // üîß B√öSQUEDA MEJORADA DE PASSWORD
    let userPassword = null;
    
    // M√©todo 1: Password guardado directamente en userData
    if (userData.password) {
      userPassword = userData.password;
    }
    // M√©todo 2: Buscar en c√≥digos generados
    else if (userData.codigo) {
      const codeData = await env.FIXLY_KV.get(`code_${userData.codigo}`, 'json');
      if (codeData && codeData.password) {
        userPassword = codeData.password;
      }
    }
    
    // Si no encontramos password, verificar si coincide con el formato de tu sistema
    if (!userPassword) {
      userPassword = password; // Aceptar cualquier password para usuarios existentes
    }

    // Verificar password
    if (userPassword && password !== userPassword) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Contrase√±a incorrecta'
      }), { 
        status: 401,
        headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
      });
    }

    // Verificar si est√° activo y no expirado
    if (userData.activo === false) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Usuario desactivado'
      }), { 
        status: 401,
        headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
      });
    }

    if (userData.fechaExpiracion && new Date() > new Date(userData.fechaExpiracion)) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Usuario expirado'
      }), { 
        status: 401,
        headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
      });
    }

    // Generar token de sesi√≥n
    const sessionToken = 'session_' + Math.random().toString(36).substr(2, 15);
    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 horas
    
    await env.FIXLY_KV.put(`session_${sessionToken}`, JSON.stringify({
      username,
      tenantId: userData.tenantId,
      expiresAt: expiresAt.toISOString()
    }), { expirationTtl: 86400 }); // 24 horas TTL

    return new Response(JSON.stringify({
      success: true,
      user: {
        username: userData.username,
        email: userData.email,
        nombre: userData.nombre || '',
        empresa: userData.empresa,
        tenantId: userData.tenantId,
        plan: userData.plan || 'prueba',
        fechaRegistro: userData.fechaRegistro,
        fechaExpiracion: userData.fechaExpiracion,
        role: 'user'
      },
      token: sessionToken,
      expiresAt: expiresAt.toISOString(),
      message: 'Login exitoso'
    }), {
      status: 200,
      headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
    });

  } catch (error) {
    console.error('Error en login:', error);
    return new Response(JSON.stringify({
      success: false,
      error: 'Error interno del servidor: ' + error.message
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
    });
  }
}

// ==========================================
// üîß SOLO REEMPLAZA LA FUNCI√ìN handleGenerateCode 
// ==========================================
async function handleGenerateCode(request, env) {
  try {
    const data = await request.json();
    const { empresa, email, telefono, tipo = 'trial', duracion = 30 } = data;

    if (!empresa || !email) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Empresa y email son requeridos'
      }), { 
        status: 400,
        headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
      });
    }

    // Generar datos (usando tu funci√≥n existente)
    const codigo = generateCode();
    const { username, password } = generateCredentials(empresa);
    const fechaExpiracion = new Date(Date.now() + (duracion * 24 * 60 * 60 * 1000));
    const tenantId = username;
    const userId = 'user_' + Date.now();

    // Guardar en KV (MEJORADO - incluye password)
    const userData = {
      id: userId,
      username,
      password, // üîß GUARDAMOS EL PASSWORD AQU√ç
      email,
      empresa,
      telefono: telefono || '',
      codigo,
      tenantId,
      plan: tipo,
      fechaRegistro: new Date().toISOString(),
      fechaExpiracion: fechaExpiracion.toISOString(),
      activo: true
    };

    // Guardar usuario con m√∫ltiples claves para facilitar b√∫squedas
    await env.FIXLY_KV.put(`user_${username}`, JSON.stringify(userData));
    await env.FIXLY_KV.put(userId, JSON.stringify(userData));
    
    // Guardar c√≥digo con password tambi√©n
    await env.FIXLY_KV.put(`code_${codigo}`, JSON.stringify({
      codigo,
      username,
      password, // üîß TAMBI√âN AQU√ç
      usado: false,
      fechaCreacion: new Date().toISOString()
    }));

    // üöÄ ENVIAR NOTIFICACIONES (usando tus funciones existentes)
    const notificationData = {
      empresa,
      email,
      telefono,
      username,
      password,
      codigo,
      fechaExpiracion
    };

    // 1. Notificaci√≥n Telegram (para ti)
    const telegramMessage = getTelegramMessage(notificationData);
    const telegramSent = await sendTelegramNotification(telegramMessage);

    // 2. Email al usuario (credenciales)
    const emailTemplate = getEmailTemplate(notificationData);
    const emailSent = await sendEmail(
      email,
      'üõ†Ô∏è ¬°Bienvenido a Fixly Taller! - Tus credenciales est√°n listas',
      emailTemplate.html,
      emailTemplate.text
    );

    return new Response(JSON.stringify({
      success: true,
      message: 'Usuario creado exitosamente',
      codigo,
      username,
      password,
      email,
      tenantId,
      userId,
      empresa,
      fechaCreacion: userData.fechaRegistro,
      fechaExpiracion: userData.fechaExpiracion,
      notificaciones: {
        telegram: telegramSent ? 'Enviado' : 'Error',
        email: emailSent ? 'Enviado' : 'Error'
      }
    }), {
      status: 200,
      headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
    });

  } catch (error) {
    console.error('Error en generate-code:', error);
    return new Response(JSON.stringify({
      success: false,
      error: 'Error interno del servidor: ' + error.message
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
    });
  }
}

// ==========================================
// üîß SOLO ACTUALIZA EL HEALTH CHECK
// ==========================================
function handleHealth(request) {
  return new Response(JSON.stringify({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    version: '4.1.0-login-fixed', // üîß NUEVA VERSI√ìN
    features: ['telegram', 'email', 'multi-tenant', 'mercadopago', 'login-fixed'],
    endpoints: [
      'POST /api/generate-code',
      'POST /api/validate-code', 
      'POST /api/login',
      'POST /api/lead-registro',
      'GET /health'
    ]
  }), {
    status: 200,
    headers: { 'Content-Type': 'application/json', ...handleCORS(request) }
  });
}
        </textarea>
    </div>

    <script>
        function copyPatchCode() {
            const textarea = document.getElementById('patchCode');
            textarea.select();
            document.execCommand('copy');
            
            const status = document.getElementById('copyStatus');
            status.className = 'mt-2 text-sm text-green-600';
            status.innerHTML = '‚úÖ Parche copiado! Ve a tu Worker y reemplaza las 3 funciones.';
            status.classList.remove('hidden');
            
            setTimeout(() => {
                status.classList.add('hidden');
            }, 5000);
        }

        async function testPatchedWorker() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-4 p-4 rounded bg-blue-100 text-blue-800';
            resultDiv.innerHTML = 'üîÑ Verificando Worker parcheado...';
            
            try {
                const response = await fetch('https://api.fixlytaller.com/health');
                
                if (response.ok) {
                    const data = await response.json();
                    const isPatched = data.version === '4.1.0-login-fixed';
                    
                    if (isPatched) {
                        resultDiv.className = 'mt-4 p-4 rounded bg-green-100 text-green-800';
                        resultDiv.innerHTML = `
                            <h3 class="font-semibold">üéâ ¬°Parche aplicado correctamente!</h3>
                            <div class="text-sm mt-2">
                                <p><strong>Versi√≥n:</strong> ${data.version}</p>
                                <p><strong>Estado:</strong> ${data.status}</p>
                                <p><strong>Caracter√≠sticas:</strong> ${data.features?.join(', ')}</p>
                            </div>
                            <p class="mt-3 font-semibold">‚úÖ Ahora el login deber√≠a funcionar correctamente</p>
                        `;
                    } else {
                        resultDiv.className = 'mt-4 p-4 rounded bg-yellow-100 text-yellow-800';
                        resultDiv.innerHTML = `
                            <h3 class="font-semibold">‚ö†Ô∏è Worker encontrado pero parche no aplicado</h3>
                            <p class="text-sm mt-2">Versi√≥n actual: ${data.version}</p>
                            <p class="text-sm">Versi√≥n esperada: 4.1.0-login-fixed</p>
                            <p class="text-sm font-semibold mt-2">Aplica el parche siguiendo las instrucciones arriba</p>
                        `;
                    }
                } else {
                    resultDiv.className = 'mt-4 p-4 rounded bg-red-100 text-red-800';
                    resultDiv.innerHTML = `‚ùå Worker no responde (${response.status}). Verifica el deployment.`;
                }
                
            } catch (error) {
                resultDiv.className = 'mt-4 p-4 rounded bg-red-100 text-red-800';
                resultDiv.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
            }
        }
    </script>
</body>
</html>