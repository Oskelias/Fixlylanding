<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Diagnóstico SPF - MailChannels</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            max-width: 1000px; 
            margin: 30px auto; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
        }
        .diagnostic-card { 
            background: white; 
            border: 1px solid #dee2e6; 
            padding: 25px; 
            margin: 20px 0; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        .info { border-left: 4px solid #17a2b8; }
        
        button { 
            background: #007bff; 
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600;
            margin: 8px;
            transition: all 0.2s;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .log-viewer {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-ok { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }
        .status-pending { background: #ffc107; color: black; }
        
        .action-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔍 Diagnóstico Avanzado SPF/MailChannels</h1>
        <p>Worker v4.2.0 - Análisis detallado del problema de email</p>
    </div>

    <!-- SPF Check -->
    <div class="diagnostic-card info">
        <h3>🌐 Verificación SPF Record</h3>
        <p>Verificando si el SPF record está propagado globalmente...</p>
        <button onclick="checkSPFPropagation()">🔍 Verificar SPF</button>
        <div id="spfResult"></div>
    </div>

    <!-- MailChannels Direct Test -->
    <div class="diagnostic-card warning">
        <h3>📧 Test Directo MailChannels API</h3>
        <p>Prueba directa contra la API de MailChannels para ver error específico.</p>
        <button onclick="testMailChannelsDirect()">📬 Test Directo</button>
        <div id="mailchannelsResult"></div>
    </div>

    <!-- Worker Logs Simulation -->
    <div class="diagnostic-card error">
        <h3>📊 Simulación de Logs Worker v4.2.0</h3>
        <p>Muestra qué logs deberías ver en Cloudflare Dashboard.</p>
        <button onclick="simulateWorkerLogs()">📋 Ver Logs Esperados</button>
        <div id="logsSimulation"></div>
    </div>

    <!-- DNS Propagation Check -->
    <div class="diagnostic-card">
        <h3>⏰ Estado de Propagación DNS</h3>
        <p>Análisis del tiempo transcurrido desde la configuración del SPF.</p>
        <div id="propagationStatus">
            <p>SPF record agregado hace: <span id="timeElapsed">Calculando...</span></p>
            <p>Estado esperado: <span id="expectedStatus" class="status-indicator status-pending">PROPAGANDO</span></p>
        </div>
        <button onclick="updatePropagationStatus()">🔄 Actualizar Estado</button>
    </div>

    <!-- Action Plan -->
    <div class="action-box">
        <h4>📋 Plan de Acción Basado en Diagnóstico</h4>
        <div id="actionPlan">
            <p>Ejecuta los diagnósticos arriba para obtener el plan específico.</p>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://api.fixlytaller.com';
        const SPF_CONFIG_TIME = new Date('2025-09-01T02:15:00Z'); // Aproximado cuando configuraste SPF

        function updateTimeDisplay() {
            const now = new Date();
            const elapsed = Math.floor((now - SPF_CONFIG_TIME) / 1000 / 60); // minutos
            
            document.getElementById('timeElapsed').textContent = `${elapsed} minutos`;
            
            const statusElement = document.getElementById('expectedStatus');
            if (elapsed < 10) {
                statusElement.textContent = 'PROPAGANDO';
                statusElement.className = 'status-indicator status-pending';
            } else if (elapsed < 20) {
                statusElement.textContent = 'DEBERÍA FUNCIONAR';
                statusElement.className = 'status-indicator status-ok';
            } else {
                statusElement.textContent = 'PROBLEMA DETECTADO';
                statusElement.className = 'status-indicator status-error';
            }
        }

        function checkSPFPropagation() {
            const resultDiv = document.getElementById('spfResult');
            resultDiv.innerHTML = `
                <h4>🔍 Verificación SPF Record</h4>
                <div class="log-viewer">
Checking SPF record for fixlytaller.com...

Expected SPF record:
"v=spf1 include:relay.mailchannels.net ~all"

⚠️ No podemos verificar DNS desde el navegador por seguridad.

📋 Para verificar manualmente:
1. Usa herramientas online:
   - https://mxtoolbox.com/spf.aspx
   - https://www.whatsmydns.net/
   
2. O desde terminal:
   dig TXT fixlytaller.com
   nslookup -type=TXT fixlytaller.com

✅ Si el record aparece: SPF propagado
❌ Si no aparece: Esperar más tiempo o reconfigurar
                </div>
                
                <div style="margin-top: 15px;">
                    <strong>Acción recomendada:</strong>
                    <p>Verifica en mxtoolbox.com si el SPF record está visible globalmente.</p>
                </div>
            `;
        }

        async function testMailChannelsDirect() {
            const resultDiv = document.getElementById('mailchannelsResult');
            resultDiv.innerHTML = '<p>🔄 Probando MailChannels directo...</p>';

            const emailData = {
                personalizations: [{
                    to: [{ email: 'direct-test@fixlytaller.com' }],
                    subject: '🧪 Test Directo MailChannels - ' + new Date().toISOString()
                }],
                from: {
                    email: 'noreply@fixlytaller.com',
                    name: 'Fixly Test Directo'
                },
                content: [{
                    type: 'text/html',
                    value: '<h1>Test Directo MailChannels</h1><p>Este es un test directo.</p>'
                }]
            };

            try {
                const response = await fetch('https://api.mailchannels.net/tx/v1/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailData)
                });

                const responseText = await response.text();
                
                resultDiv.innerHTML = `
                    <h4>📬 Resultado Test Directo MailChannels</h4>
                    <div class="log-viewer">
Status: ${response.status}
Success: ${response.ok ? '✅' : '❌'}

Response Body:
${responseText}

Analysis:
${response.status === 401 ? 
    '❌ 401 Unauthorized - SPF record not propagated or incorrect' :
response.status === 403 ?
    '❌ 403 Forbidden - Domain not verified with MailChannels' :
response.status === 422 ?
    '❌ 422 Unprocessable - Email format error' :
response.ok ?
    '✅ Success - MailChannels is working!' :
    '❌ Unknown error - Check response details'
}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <h4>❌ Error en Test Directo</h4>
                    <div class="log-viewer">Error: ${error.message}</div>
                `;
            }
        }

        function simulateWorkerLogs() {
            const resultDiv = document.getElementById('logsSimulation');
            resultDiv.innerHTML = `
                <h4>📊 Logs Esperados en Cloudflare Workers</h4>
                <p>Esto es lo que deberías ver en: <strong>Cloudflare Dashboard → Workers → fixly-backend → Logs</strong></p>
                
                <div class="log-viewer">
📧 Email attempt 1/2 to: v420-test@fixlytaller.com
📤 Sending email via MailChannels...
From: noreply@fixlytaller.com
To: v420-test@fixlytaller.com
Subject: 🛠️ ¡Bienvenido a Fixly Taller! - Tus credenciales están listas

📬 MailChannels Response - Status: [STATUS_CODE]
📬 MailChannels Response - Body: [ERROR_DETAILS]

Possible Status Codes:
• 401 = SPF record not propagated yet
• 403 = Domain not verified  
• 422 = Email format issue
• 200 = Success! Email sent
• 500 = MailChannels temporary issue

🔧 Si ves Status 401:
   - SPF record aún propagando
   - Esperar 5-10 minutos más
   
🔧 Si ves Status 403:
   - Problema de verificación de dominio
   - Contactar soporte MailChannels
   
🔧 Si ves Status 200:
   - ¡Email funcionando correctamente!
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 6px;">
                    <strong>📋 Cómo ver logs reales:</strong>
                    <ol>
                        <li>Cloudflare Dashboard → Workers & Pages</li>
                        <li>Selecciona "fixly-backend"</li>
                        <li>Click en pestaña "Logs"</li>
                        <li>Crea un usuario en admin panel</li>
                        <li>Ve los logs detallados en tiempo real</li>
                    </ol>
                </div>
            `;
        }

        function updatePropagationStatus() {
            updateTimeDisplay();
            
            const actionPlan = document.getElementById('actionPlan');
            const elapsed = Math.floor((new Date() - SPF_CONFIG_TIME) / 1000 / 60);
            
            if (elapsed < 10) {
                actionPlan.innerHTML = `
                    <h4>⏳ FASE: Propagación en curso (${elapsed}/10 min)</h4>
                    <ul>
                        <li>✅ SPF record configurado correctamente</li>
                        <li>⏱️ Esperar propagación DNS (normal: 5-15 min)</li>
                        <li>📧 Emails fallarán hasta que propague</li>
                        <li>🔄 Reintentar cada 5 minutos</li>
                    </ul>
                `;
            } else if (elapsed < 20) {
                actionPlan.innerHTML = `
                    <h4>🧪 FASE: Debería funcionar (${elapsed} min transcurridos)</h4>
                    <ul>
                        <li>✅ Tiempo suficiente para propagación</li>
                        <li>🔍 Verificar logs de Cloudflare Worker</li>
                        <li>📧 Probar envío de email nuevamente</li>
                        <li>🌐 Verificar SPF en mxtoolbox.com</li>
                    </ul>
                `;
            } else {
                actionPlan.innerHTML = `
                    <h4>🚨 FASE: Posible problema (${elapsed} min)</h4>
                    <ul>
                        <li>❌ SPF debería estar propagado</li>
                        <li>🔍 Revisar configuración del SPF record</li>
                        <li>🌐 Verificar DNS en herramientas externas</li>
                        <li>📞 Posible contacto con soporte MailChannels</li>
                        <li>🔄 Considerar servicios alternativos (Resend, SendGrid)</li>
                    </ul>
                `;
            }
        }

        // Auto-update timer
        setInterval(updateTimeDisplay, 30000); // cada 30 segundos
        updateTimeDisplay(); // inicial
        updatePropagationStatus(); // inicial
    </script>
</body>
</html>